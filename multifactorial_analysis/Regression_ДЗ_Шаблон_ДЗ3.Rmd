---
title: '**Название исследования**'
author: "Выполнил(и): Оксана Пластинина"
output:
  html_document:
    number_sections: true
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(readxl)
library(tidyverse)
library(gtsummary)
library(ggplot2)
library(patchwork)
library(ggmosaic)
library(flextable)
library(ggResidpanel)
library(ggfortify)
library(GGally)
library(lmtest)
```

```{r}
data <- read_excel("data/raw/HW_data.xlsx")
dictionary <- read_excel("data/raw/HW_dictionary.xlsx")
```

```{r}
data <- data %>% 
  mutate(cigar_col = case_when(cigar == 0 ~ NA,
                               TRUE ~ cigar))
```


```{r}
thememine <- theme(
  plot.title = element_text(size = 15, hjust = 0.5),
  axis.title = element_text(size = 12),
  axis.text = element_text(size = 9, colour = 'grey10'),
  panel.background = element_rect(fill = 'white'),
  panel.grid = element_line(colour = 'grey90')
)

theme_set(thememine)
```

```{r}
tobaccolabels <- c('0' = 'Не курит', '1' = 'Курит')
```

```{r echo=FALSE}
#dtotord? adequacy? 

datan <- data %>% 
  mutate(across(c(mrace3, dmar, dmeduc3, dtotord, dlivord, medrisk, tobacco, alcohol, pldel, delmeth, csex, labor, newborn, congenit, death,  adequacy), as.factor))

```

<br>

# **Постановка задачи**

Поставлена задача изучить влияние курения матери на два исхода: 
- количественный (изменение среднего значения веса ребенка)
- бинарный (изменение вероятности развития осложнений)

Мы хотим измерить всю совокупность последствий курения: как прямого воздействия на исходы, так и всех возможных косвенных эффектов, проходящих через другие переменные. Например, курение может напрямую снижать вес плода, а также может влиять на него косвенно, повышая риск осложнений, которые, в свою очередь, тоже влияют на вес.С помощью DAG мы сможем оценить струкутуру данных.

Хотя вред курения во время беременности широко известен, цель этого исследования — не просто подтвердить его наличие, а точно измерить величину этого эффекта в конкретной выборке. Это может быть полезно для информирования беременных женщин и их семей с использованием конкретных цифр.

Задание 2.

Т.к. наша цель состоит в понимании влияния курения на исходы беременности и формулирование причинно-следственных связей нам не достаточно просто предсказывать опредленный количественный или вероятностный исход, а нужно понимать вклад определенных внешних факторов. Поэтому каузальная модель, учитывающая роль переменных в исследовании (конфаундеров, медиаторов и коллайдеров), позволяет оценить влияния именно нашей переменной (курения) на выбранные исходы беременности.

Оценку эффектов могут искажать следующие ошибки:
- confounding. При упущении конфаундера, например, генетическая предрасположенность или переживание травматического события во время беременности, могут повлиять на статус курения и наши исходы; 
- selection bias. Может иметь место в следующих случаях: не включение в исследование случаев с разным сроком рождения ребенка;
- information bias. Может иметь место в следующих случаях: женщины врали относительно своего статуса курильщика; в рамках исследования не оценивали частоту курения (у нас есть такая переменная); система оценки осложений разнилась у врачей/исследовательских центров.

Перечисленные ошибки повлияют на индентичность сравниваемых групп и соответсвенно на корректность сформулированных причинно-следственных связей. Перчисленные недочеты можно решить на этапе дизайна за счет включения конфаундеров и строгого регламентирования групп и методов оценки переменных.

На стадии анализа данных мы можем провести стратификацию по конфаундерам, однако, ошибки в оценке переменных и неполноте данных скорректировать на этом этапе нельзя. 

Курение матери во время беременности может приводить как к пониженному весу ребенка при рождении [1,2].

Курение матери во время беременности может приводить к преждевременным родам, гибели ребенка до или во время родов [1,2].

# **Материалы и методы**

# Модель 1 

## Анализ конечной точки 1 модели

Для первичной конечной точки оценивается линейная регрессия методом наименьших квардратов. Для контроля смешивающих факторов использовали модель множественной линейной регресии с включением ковариат, отобранных с помощью каузального графа.

С помощью каузального графа определили следующие роли переменных:
Воздействие - курения матери во время беременности
Исход - вес при рождении
Конфаундеры, влияющие напрямую - возраст, раса, образование матери, употребление алкоголя матерью, пренатальный уход
Конфаундеры, которые напрямую не влияют на воздействие и/или исход - медицинские риски (напрямую влияет только на исход, через пренатальный уход влияет на воздействие)
Конкурирующее воздействие на исход - пол ребенка
Коллайдеры - смерть ребенка и осложнения при родах
Нейтральные, влияющие на исход - пол ребенка, номер беременности
Нейтральные переменные - тип родов

## DAG и отбор ковариат модели

DAGitty предлагает минимально достаточный набор конфаунлеров для оценки прямого влияния курения матери на массу ребенка при рождении: Возраст матери, Употребление алкоголя матерью, Образование матери, Расовая принадлежность матери, Пренатальный уход

Но мы можем также включить в модель дополнительно конфаундер - медицинские риски, который через медиатор пренатальный уход влияет на воздействие и напрямую - на исход. 

Медиатор, коллайдеры и нейтральные переменные - не включаем, чтобы не допустить смещение и не перегружать модель

```{r}
DAG1 <- readxl::read_excel("DAG1.xlsx")

DAG1
```

### Другие возможные конфаундеры, которые не представлены в данном графе?

Предполагаем, что исследователь не представил на графе в качестве конфаундера переменную "Marital status of mother".

Предполагаем, что данный параметр может быть конфаундером, т.к. условия жизни матери во время беременности, а именно отсутствие семьи, может спровоцировать курение матери, что влияет и на осложнения при родах.

Предполагаем, что включение этого конфаундера в модель незначительно повлияет на результат работы модели, поэтому не включено в даг. 

Помимо данных, представленных в датасете, конфаудерами могли бы быть:

- Условия жизни матери во время беременности,
- Уровень стресса во время беременности,
- Сопутствующие заболевания матери,
- Доход матери.

## Измерение ключевых показателей:

Измерение курения матери во время беременности - 
Вес ребенка - средний вес ребенка при рождении (кол.пер)
Ковариаты в модели: 
Возраст матери - средний возраст в годах (кол.пер.)
Образование матери - 17 категорий (кат.пер.)
Расовая принадлежность матери -  (кат.пер.)
Пренатальный уход - Адекватность дородового ухода (кат.пер.)
Употребление алкоголя матерью 

Диагностику линейности модели проводили с использованием визуальных методов путем построения графиков отношения остатков и предсказанных знаений и остатков и отдельных предикторов.

# Модель 2

## Анализ конечной точки 2 модели

Воздействие - курения матери во время беременности, 

Исход - осложнения во время родов

Конфаундеры, влияющие напрямую - употребление алкоголя матерью, возраст матери

Конфаундеры, которые напрямую не влияют на воздействие и/или исход - раса матери, образование матери, медицинские риски, пренатальный уход
Медиаторы - вес ребенка
Нейтральные, влияющие на исход - пол ребенка, кол-во предыдущих родов и метод родов 
Нейтральные переменные - младенческая смерть

## DAG и отбор ковариат модели

DAGitty предлагает целых 5 вариантов минимально достаточных групп конфаундеров для оценки прямого влияния курения матери на вероятность возникновения осложнений при родах

Тип родов, медицинские риски, возраст матери, употребление алкоголя матерью

Медицинские риски, возраст, образование, раса матери, употребление алкоголя матерью

Медицинские риски, возраст матери, употребление алкоголя матерью, количество предыдущих родов

Возраст матери, употребление алкоголя матерью, образование матери, раса матери, дородовой уход

Возраст матери, употребление алкоголя матерью, количество предыдущих родов, дородовой уход

Считаем, что в итоговую модель стоит включить прямые конфаундеры - употребление алкоголя матерью и возраст матери. А также остальные конфаундеры, которые имеют большее отношение именно к родам - медицинские риски, пренатальный уход, а также раса и образование матери. Нейтральные переменные - не включаем

DAGitty предлагает не все конфаундеры одновременно, или предлагает добавить в модель медиаторы, возможно, так как переменные так же связаны друг с другом каузальными связями

```{r}
DAG2 <- readxl::read_excel("DAG2.xlsx")

DAG2
```

### Другие возможные конфаундеры, которые не представлены в данном графе?

Предполагаем, что исследователь не представил на графе в качестве конфаундера переменную "Marital status of mother".

Предполагаем, что данный параметр может быть конфаундером, т.к. условия жизни матери во время беременности, а именно отсутствие семьи, может спровоцировать курение матери, что влияет и на вес новорожденного.

Предполагаем, что включение этого конфаундера в модель незначительно повлияет на результат работы модели, поэтому не включено в даг. 

Помимо данных, представленных в датасете, конфаудерами могли бы быть:
- Условия жизни матери во время беременности,
- Уровень стресса во время беременности,
- Сопутствующие заболевания матери.

## Измерение ключевых показателей:

Измерение курения матери во время беременности - 
Осложнения во время родов 
Ковариаты в модели: 
Употребление алкоголя матерью
Возраст матери 
Образование матери
Расовая принадлежность матери
Пренатальный уход



## **Дизайн исследования**

Данное исследование представляет собой кросс-секционное (поперечное) исследование, основанное на анализе собранных данных о беременности и родах. В исследовании приняли участие 537 женщин, данные о которых были получены из медицинской документации и опросников. Особенностью данного дизайна является то, что все переменные измерялись одновременно, в период родоразрешения, что позволяет оценить существующие ассоциации между изучаемыми факторами, но не устанавливать временную последовательность событий. Для повышения валидности получаемых результатов в данном исследовании применяются методы статистического контроля конфаундинга на основе предварительно построенного причинно-следственного графа (DAG), что позволяет минимизировать смещение оценок и более обоснованно интерпретировать обнаруженные ассоциации.

## **Конечные точки**

Модель 1: Влияние курения на вес при рождении
Конечная точка:
Переменная: dbirwt (вес при рождении в граммах)
Тип: Непрерывная количественная переменная
Параметр оценки: Средняя разница веса (β-коэффициент)
Метод анализа: Множественная линейная регрессия

Модель 2: Влияние курения на вероятность осложнений при родах
Конечная точка:
Переменная: labor (осложнения во время родов)
Тип: Бинарная переменная (0 = нет осложнений, 1 = есть осложнения)
Параметр оценки: Отношение шансов (OR - Odds Ratio)
Метод анализа: Логистическая регрессия

## **Описательные статистики**

Для описания исходных данных использовались следующие описательные статистики:
Для непрерывных переменных:
-Среднее значение и стандартное отклонение
-Медиана
-Минимум и максимум
-Визуализация распределения с помощью гистограмм и боксплотов. 
Для категориальных переменных:
-Абсолютные частоты (n)
-Относительные частоты (%)
-Визуализация с помощью столбчатых диаграмм


## **Анализ дополнительных конечных точек**

...

<br>

# **Результаты**

## **Описательная статистика и эксплораторный анализ**




## **Результаты эксплораторного анализа конечной точки 1**

Средний вес новорожденных составил 3366.58 грамм при стандартном отклонении 573.59 грамм, что свидетельствует о существенном разбросе значений вокруг среднего. Медианное значение веса (3402.00 грамм) несколько превышает среднее арифметическое, что указывать на легкую левостороннюю асимметрию распределения, что подтвкерждает визуализация (Приложение 2).

Диапазон значений веса при рождении варьировал от 1134.00 грамм до 4876.00 грамм, что отражает значительную вариабельность изучаемого показателя в выборке. Наличие случаев с экстремально низким весом (1134 г) может быть связано с недоношенностью, задержкой внутриутробного развития или другими патологическими состояниями, в то время как максимальные значения приближаются к верхней границе нормального веса доношенных новорожденных.

Сравнение среднего значения с общепопуляционными нормами (обычно 2500-4000 г для доношенных детей) показывает, что исследуемая выборка в целом соответствует ожидаемым параметрам, однако наличие случаев как с очень низким, так и с высоким весом требует дополнительного анализа потенциальных факторов, влияющих на этот показатель.

Размер стандартного отклонения (около 17% от среднего значения) указывает на умеренную вариабельность веса при рождении в изучаемой популяции, что является типичным для данного антропометрического показателя.


## Результаты анализа конечной точки 1

В нашем исследовании подавляющее число пациенток не курило во время беременности, из-за чего в распределнии среднего числа выкуренных сигарет в день наблюдается пик в области 0 значений. Из-за такого характера данных взаимосвязь веса ребенка и количественной переменной среднего числа сигарет в день имеет нелинейный характер (см. Взаимосвязь веса реебнка при рождении и среднего числа выкуренных матерью сигарет в день). В связи с этим эффект влияния курения матери во время беременности на вес ребенка при рождении оценивали двумя путями: 1) определяли влияния статуса курения на вес с использованием бинарной переменной статуса курения; 2) определяли дозозависимый эффект числа сигарет на вес ребенка при рождении и с использованим количественной переменной числа выкуренных при беременности сигарет среди курильщиков (см. распределее среднего числа выкуренных сигарет в день среди курящих пациентов и ).

```{r fig.height=5, fig.width=8}
data %>% 
  ggplot(aes(x = cigar, y = dbirwt))+
  geom_jitter()+
  geom_smooth(se = FALSE, method = 'lm')+
  labs(
    title = 'Взаимосвязь веса реебнка при рождении и \nсреднего числа выкуренных матерью сигарет в день',
    x = 'Число сигарет',
    y = 'Вес ребенка при рождении, г'
  )
  
```

```{r fig.height=5, fig.width=8}
data %>% 
  ggplot()+
  geom_histogram(aes(x = cigar_col), fill = 'seagreen', colour = 'black')+
  labs (
    title = 'Распределение среднего числа выкуренных сигарет в день \nсреди курящих пациентов',
    x = 'Количество сигарет',
    y = 'Количество пациентов'
  )+
  scale_x_continuous(breaks = seq(0,30, 5))+
  scale_y_continuous(breaks = seq(0,40, 5))

```

```{r fig.height=5, fig.width=8}
data %>% 
  ggplot(aes(x = cigar_col, y = dbirwt))+
  geom_jitter()+
  geom_smooth(se = FALSE, method = 'lm')+
  labs(
    title = 'Взаимосвязь веса реебнка при рождении и \nсреднего числа выкуренных матерью сигарет в день среди курильщиков',
    x = 'Число сигарет',
    y = 'Вес ребенка при рождении, г'
  )+
  scale_x_continuous(breaks = seq(0,30, 5))
```


### Модель зависимости веса ребенка при рождении от курения матери без смешивающих факторов

#### Диагностика зависимости веса ребенка от статуса курения матери

Для диагностики зависимости веса ребека от статуса курения матери во время беременности использовали линейную регрессию без поправки на смешивающие факторы. Диагностика модели показала гомоскедастичность остатков, но их ненормальное распределение в области < -2 sd (приложение 3А). В связи с этим при оценке р-значения и ДИ использовали скорректированные стандартные ошибки. 

```{r}
fit10 <- lm(data$dbirwt ~ data$tobacco, data)

coeftest(fit10, vcov. = vcovHC, conf.int = TRUE) %>% broom::tidy()

```

Cогласно линейной регрессии расчитанной по методу наименьших квадратов без поправки на смешающие факторы средний вес ребенка при рождении у некурящей матри равен 3408 гр (95% ДИ [3354; 3461]), куруние матери в среднем приводит к снижению веса реебнка при рождении на 228 гр (95% ДИ [-350; -105]).

#### Определение дозозависимого эффекта курения матери

Для определения дозозависимого эффекта курения матери во время беременности на вес ребенка использовали линейную регрессию без поправки на смешивающие факторы. Диагностика модели показала линейное распределение остатков относительно 0, отсутвие влиятельных наблюдений, но ненормальное распределение остатков в областях +/- 1,5 sd и гомоскедастичность остатков (Приложение 3Б). В связи с этим при оценке р-значения и ДИ использовали скорректированные стандартные ошибки. 

```{r}
fit11 <- lm(data$dbirwt ~ data$cigar_col, data)

coeftest(fit11, vcov. = vcovHC, conf.int = TRUE) %>% broom::tidy()

```

Cогласно линейной регрессии расчитанной по методу наименьших квадратов без поправки на смешающие факторы средний вес ребенка при рождении у некурящей матерей равен 3309 гр (95% ДИ [3309; 3543]), каждая выкуренная сигарета снижает вес ребенка при рождении на 9.68 гр (95% ДИ [-23.85; -4.48]).

### Модель зависимости веса ребенка при рождении от курения матери с учетом смешивающих факторов

#### Модель зависимости веса ребенка при рождении от курения матери с учетом смешивающих факторов

Для диагностики зависимости веса ребека от статуса курения матери во время беременности использовали линейную регрессию с учетом следующих смешивающих факторов: количество выпитых в течение беременности спиртных напитков, возраст матери, наличие медицинских рисков, раса матери, качество пренатального ухода, образование матери.
Диагностика модели показала линейное распределение остатков относительно 0, отсутвие влиятельных наблюдений, но ненормальное распределение остатков в областях <-2 sd и гомоскедастичность остатков (Приложение 4А). В связи с этим при оценке р-значения и ДИ использовали скорректированные стандартные ошибки. 

```{r}
fit20 <- lm(data$dbirwt ~ data$tobacco + data$drink + data$dmage + data$medrisk + data$adequacy + data$mrace3 + data$dmeduc3, data)

coeftest(fit20, vcov. = vcovHC, conf.int = TRUE) %>% broom::tidy()
```

Cогласно линейной регрессии рассчитанной по методу наименьших квадратов с поправкой на смешающие факторы средний вес ребенка при рождении у некурящих матерей равен 3287 гр (95% ДИ [2965; 3609]), куруние матери в среднем приводит к снижению веса ребенка при рождении на 185 гр (95% ДИ [-310; -60]).

#### Определение дозозависимого эффекта курения матери

Для определения дозозависимого эффекта курения матери во время беременности на вес ребенка использовали линейную регрессию с учетом следующих смешивающих факторов: количество выпитых в течение беременности спиртных напитков, возраст матери, наличие медицинских рисков, раса матери, качество пренатального ухода, образование матери.

```{r}
fit21 <- lm(data$dbirwt ~ data$cigar_col + data$drink + data$dmage + data$medrisk + data$adequacy + data$mrace3 + data$dmeduc3, data)
```

Диагностика модели показала нелинейное распределение остатков относительно 0, отсутвие влиятельных наблюдений, ненормальное распределение остатков в областях > 1,5 sd и гетероскедастичность (Приложение 4Б). 

Детальное рассмотрение распределения остатков у количественных переменных модели определило, что вклад в нелинейность вносят обе переменные (количество сигарет и возраст) (Приложение 4В). 

Преобразование модели путем логарифмирования веса ребенка (Приложение 4Г) и категоризация переменной возраста (Приложение 4Д) после рождения не позволило линеризовать распределение остатков.

### Определение влияния этноса матери на полный каузальный эффект курения на вес ребенка при рождении

Для оценки  влияния возраста этноса матери на полный каузальный эффект курения на вес ребенка при рождении построили две модели c учетом и без учета взаимодействия статуса курения и возраста матери. Остатки обеих моделей распределены гомоскедастично. Для определения влияния возраста матери на полный каузальный эффект курения на вес ребенка при рождении использовали anova. 

Согласно резульататом anova влияние этноса матери не оказывает статистически значимое влияния (по уровню значимости 0,05, p-значение = 0.1127) на полный каузальный эффект курения на вес ребенка при рождении. 


```{r}
fit20 <- lm(data$dbirwt ~ data$tobacco + data$drink + data$dmage + data$medrisk + data$adequacy + data$mrace3 + data$dmeduc3, data)

fit30 <- lm(data$dbirwt ~ data$tobacco*data$mrace3 + data$drink + data$dmage + data$medrisk + data$adequacy + data$dmeduc3, data)

autoplot(fit30)
```

```{r}
anova(fit20, fit30)
```


### Определение влияния возраста матери на полный каузальный эффект курения на вес ребенка при рождении

Для оценки  влияния возраста матери на полный каузальный эффект курения на вес ребенка при рождении построили две модели c учетом и без учета взаимодействия статуса курения и возраста матери. Остатки обеих моделей распределены гомоскедастично. Для определения влияния возраста матери на полный каузальный эффект курения на вес ребенка при рождении использовали anova. 

Согласно резульататом anova возраст матери не оказывает значимое влияния на полный каузальный эффект курения на вес ребенка при рождении. 

```{r}
fit20 <- lm(data$dbirwt ~ data$tobacco + data$drink + data$dmage + data$medrisk + data$adequacy + data$mrace3 + data$dmeduc3, data)

fit40 <- lm(data$dbirwt ~ data$tobacco*data$dmage + data$drink + data$medrisk + data$adequacy + data$dmeduc3 + data$mrace3, data)

autoplot(fit40)
```
```{r}
anova(fit20, fit40)
```




## **Результаты эксплораторного анализа конечной точки 2**

Распределение осложнений во время родов и/или родоразрешения в исследуемой выборке показывает следующую картину:

В общей сложности осложнения были зарегистрированы у 176 женщин (33%) из 537 наблюдений (Приложение 1). Это означает, что примерно каждая третья женщина в исследовании столкнулась с теми или иными осложнениями в процессе родов.

Большинство родов (67%) прошли без осложнений - такая картина наблюдалась у 361 женщины. Полученное соотношение 2:1 (два случая неосложненных родов на один случай с осложнениями) указывает на то, что хотя осложнения являются частым явлением, нормальное течение родов все же преобладает в изучаемой популяции.

## **Результаты анализа дополнительных конечных точек**

...

В качестве дополнительных конечных точек рассматривали смерть ребенка при рождении, наличие любых ненормальных состояний при рождении, наличие любых врожденных аномалий и количество недель беременности.
Анализ влияния курения на смерть ребенка при рождении и наличие любых врожденных аномалий не проводили, т.к для этих характеристик в исследовании зарегистрирован один и 0 случаев соответственно.

Среднее значение недели родов (39 недель со страндартным отклонением 2.4) соответсвует нормальным срокам родоразрешения. Неделя, на которой происходили роды варьировал от 28 до 47 недель. При этом количество женщин, родивших раньше 35 недели больше в группе не курящих женщин.

Ненормлаьные состояния после рождения зарегистрированы только в 6,3 % случаев в больншинстве у не курящих женщин.

...

<br>

# **Ограничения**

...

<br>

# **Выводы**

...

<br>

# **Источники литературы**

1. Delcroix M.-H., Delcroix-Gomez C., Marquet P., Gauthier T., Thomas D., Aubard Y. Active or passive maternal smoking increases the risk of low birth weight or preterm delivery: Benefits of cessation and tobacco control policies//Tobacco Induced Diseases, 2023, Vol. 21, Active or passive maternal smoking increases the risk of low birth weight or preterm delivery, No. May, P. 1-13.

2. Hamadneh S., Hamadneh J. Active and Passive Maternal Smoking During Pregnancy and Birth Outcomes: A Study From a Developing Country//Annals of Global Health, 2021, Vol. 87, Active and Passive Maternal Smoking During Pregnancy and Birth Outcomes, No. 1.
...

<br>

# **Использование ИИ**

...

<br>

# **Приложения**

## **Приложение 1**

```{r}

categorical_table

```

<br>

## **Приложение 2**

```{r}
continuous_table
```

<br>

## **Приложение 3А**

Диагностика зависимости веса ребека от статуса курения матери во время беременности использовали линейную регрессию без поправки на смешивающие факторы

```{r fig.height=3, fig.width=9}
autoplot(fit10, c(1,2))
```

## **Приложение 3Б**
```{r}
autoplot(fit11)
```

## **Приложение 4А**

```{r}
autoplot(fit20)
```

## **Приложение 4Б**

```{r}
autoplot(fit21)
```

## **Приложение 4В**

```{r}
resid_xpanel(fit21, smoother = TRUE)
```


## **Приложение 4Г**

```{r}
fit22 <- lm(log(data$dbirwt) ~ data$cigar_col + data$drink + data$dmage + data$medrisk + data$adequacy + data$mrace3 + data$dmeduc3, data)

autoplot(fit22)
```

## **Приложение 4Д**

```{r}
catage <- cut(data$dmage, breaks = c(0,20,25,30,35,100))

fit23 <- lm(data$dbirwt ~ data$cigar_col + data$drink + catage + data$medrisk + data$adequacy + data$mrace3 + data$dmeduc3, data)

autoplot(fit23)
```


## **Приложение 5**
```{r}
resid_xpanel(fit2, smoother = TRUE)
```

