---
title: "Восполнение пропущенных значений"
author: "Oksana Plastinina"
date: "`r Sys.Date()`"
output: 
  html_document:
    number_sections: true
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE}
library(tidyverse)
library(ggplot2)
library(ggResidpanel)
library(ggfortify)
library(mice)
library(lmtest)
library(sandwich)
library(flextable)
```

```{r}
thememine <- theme(
  plot.title = element_text(size = 15, hjust = 0.5),
  plot.subtitle = element_text(size = 16, hjust = 0.5),
  axis.title = element_text(size = 12),
  axis.text = element_text(size = 9, colour = 'grey10'),
  panel.background = element_rect(fill = 'white'),
  panel.grid = element_line(colour = 'grey90')
)

theme_set(thememine)
```


```{r}
data <- read.csv('data.csv')
```

```{r}
#меняем тип некотрых переменных, создаем перменную ИМТ
data <- data %>% 
  mutate(
    male = as.factor(male),
    insulin = as.factor(insulin),
    bmi = weight/ (height/100)^2
  )

# summary(data)
```


# **Модель 1. Оценка ассоциации ИМТ с уровнем гликированного гемоглобина**

Исходя из графика взаимосвязи ИМТ и уровня гликированного гемоглобина, переменные имеют небольшую позитивную ассоциацию.

```{r}
data %>% 
  ggplot(aes(y = glycohemoglobin, x = bmi))+
  geom_point()+
  geom_smooth(method = 'lm', se = F, colour = 'purple')
```

Количественно связь между ИМТ и уровнем гликированного гемоглобина оценивали с помощью линейной регрессии, построенной методом наименьших квадратов.

```{r warning=FALSE}
fit1 <- lm(glycohemoglobin ~ bmi, data)

autoplot(fit1)

summary(fit1)

coeftest(fit1, vcov. = vcovHC, conf.int = TRUE) %>% 
  broom::tidy() 

# 0.006343161 + 1.96*0.007334987
# 0.006343161 - 1.96*0.007334987
```

В связи с ненормальным распределением остатков модели, стандарные ошибки оценивали с использованием робастных стандартных ошибки по Хубера-Уайта типа HC3. 

Согласно полученой линейной модели заивисимости уровня гликированного гемоглобина от ИМТ, увеличение ИМТ на 1 кг/м^2 статистически не значимо увеличивает уровень гликированного гемоглобина на 0,006% п.п. (95% ДИ [-0.008; 0.021], р-значение = 0.38).

Однаков, в процессе анализа теряется 261 наблюдений (28.6% от всех наблюдений), что может исказить полученную оценку.

# **Модель 2. Оценка ассоциации ИМТ с уровнем гликированного гемоглобина в зависимости от применения препаратов инсулина**

Исходя из графика взаимосвязи ИМТ и уровня гликированного гемоглобина в зависимости от применения препаратов инсулина, группы имеют разное направление ассоциации: пациенты, принимающие инсулин имеют небольшую отрицательную ассоциации, пациенты не примнимающие - небольшую положительную.

```{r}
data %>% 
  filter(!is.na(insulin)) %>% 
  ggplot(aes(y = glycohemoglobin, x = bmi, colour = insulin))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)

```

Количественно связь между ИМТ и уровнем гликированного гемоглобина в зависимости от применения препаратов инсулина оценивали с помощью линейной регрессии, построенной методом наименьших квадратов.

```{r}
fit2 <- lm(glycohemoglobin ~ bmi*insulin, data)

autoplot(fit2)

summary(fit2)

coeftest(fit2, vcov. = vcovHC, conf.int = TRUE) %>% 
  broom::tidy()

# 0.009860495 + 1.96*0.01110287
# 0.009860495 - 1.96*0.01110287
# 
# 1.872723369 + 1.96*0.45767046
# 1.872723369 - 1.96*0.45767046
# 
# -0.016282995 - 1.96*0.01384291
# -0.016282995 + 1.96*0.01384291
```

В связи с ненормальным распределением остатков модели и их гетероскедастичность, стандарные ошибки оценивали с использованием робастных стандартных ошибки по Хубера-Уайта типа HC3. 

Согласно полученой линейной модели зависимости уровня гликированного гемоглобина от ИМТ с учетом применения препаратов инсулина:

1) увеличение ИМТ на 1 кг/м^2 статистически не значимо увеличивает уровень гликированного гемоглобина на 0,010% п.п. (95% ДИ [-0.011; 0.032], р-значение = 0.37).

2) Прием препаратов инсулина статистически значимо повышает уровень гликированного гемоглобина 1.87% п.п. (95% ДИ [0.98; 2.77], р-значение = 4.88 × 10⁻⁵).

3) наблюдается статистически незначимый эффект группы: эффект имт статистически не значимо различается между группами пациентов принимающих и не принимаюх инсулин на на -0,016% п.п. (95% ДИ [-0,043; 0.011], р-значение = 0.24).

Однаков, в процессе анализа теряется 326 наблюдений (35.7% от всех наблюдений), что может исказить полученную оценку.

# **Модель 3: Оценка ассоциации ИМТ с уровнем гликированного гемоглобина в зависимости от применения препаратов инсулина с контролем пола и возраста**

Исходя из графика видно, что уровень гликированного гемоглобина у мужчин и женщин распределен одинаково, уровень гликированного гемоглобина выше у пациентов, принимающих препараты инсулина вне заивисимости от пола.

```{r}
data %>% 
  filter(!is.na(insulin)) %>% 
  ggplot()+
  geom_boxplot(aes(y = glycohemoglobin, x = male, fill = insulin))
```

Исходя из графика взаимосвязи ИМТ и уровня гликированного гемоглобина в зависимости от пола, обе группы имеют небольшую положительную ассоциацию данных переменных.

```{r}
data %>% 
  ggplot(aes(x = glycohemoglobin, y = bmi, colour = male))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)
```

Исходя из графика взаимосвязи возраста и уровня гликированного гемоглобина в зависимости от приема препаратов инсулина две группы имеют разные направления ассоциации: пациенты, принимающие инсулин имеют небольшую отрицательную ассоциацию, пациенты не принимающие - небольшую положительную.

```{r}
data %>% 
  filter(!is.na(insulin)) %>% 
  ggplot(aes(y = glycohemoglobin, x = age, colour = insulin))+
  geom_point()+
  geom_smooth(method = 'lm', se = F)
```

Количественно связь между ИМТ и уровнем гликированного гемоглобина с учетом факторов возраста и пола оценивали с помощью линейной регрессии, построенной методом наименьших квадратов.

```{r}
fit3 <- lm(glycohemoglobin ~ bmi*insulin + male + age, data)

autoplot(fit3)

summary(fit3)

coeftest(fit3, vcov. = vcovHC, conf.int = TRUE) %>% 
  broom::tidy()

# 0.005651093 + 1.96*0.011526160
# 0.005651093 - 1.96*0.011526160
# 
# 1.874572954 + 1.96*0.463894969	
# 1.874572954 - 1.96*0.463894969	
# 
# -0.013590301 - 1.96*0.014092220
# -0.013590301 + 1.96*0.014092220
```

В связи с ненормальным распределением остатков модели и их гетероскедастичность, стандарные ошибки оценивали с использованием робастных стандартных ошибки по Хубера-Уайта типа HC3. 

Согласно полученой линейной модели зависимости уровня гликированного гемоглобина от ИМТ с учетом применения препаратов инсулина и поправкой на пол и возраст:

1) увеличение ИМТ на 1 кг/м^2 статистически не значимо увеличивает уровень гликированного гемоглобина на 0,006% п.п. (95% ДИ [-0.017; 0.028], р-значение = 0.62).

2) Прием препаратов инсулина статистически значимо повышает уровень гликированного гемоглобина 1.87% п.п. (95% ДИ [0.97; 2.78], р-значение = 6.04 × 10⁻⁵).

3) наблюдается статистически незначимый эффект группы: эффект имт статистически не значимо различается между группами пациентов принимающих и не принимаюх инсулин на -0,014% п.п. (95% ДИ [-0.041; 0.014], р-значение = 0.36).

Однаков, в процессе анализа теряется 326 наблюдений (35.7% от всех наблюдений), что может исказить полученную оценку.

# **ИМпутация с NA**

В связи с высокой долей пропущенных данных в анализах: 28.6% от всех наблюдений в модели 1 и 35.7 % в моделях 2 и 3 - для уточнения данных приняли решение провести анализ паттернов пропусков. 

Анализ паттерно пропусков проводили визуально. Исходя из рисунка видна зависимость пропусков, примерно половина пропусков перменной уровня гликированного гемоглобина связана с пропусками в переменной ИМТ (наблюдения роста и веса соответвенно). Такой паттер исключает механизм MCAR и свидетельствует скорее о MAR.

Клинически эта картинка объяснима, пациенты не пропускающие прием, где происходит замер роста и веса, соотвественно пропустят назначение и сдачу анализов, в том числе на уровень гликированного гемоглобина. 

```{r fig.height=8, fig.width=15}
mice::md.pattern(data 
                 # %>% select(-c(weight, height))
                 )
```

Таким образом оценки моделей 1-3 возможно имеют смещенных характер, в связи с чем приняли решения импутации пропущенных данных и последующем анализе восполненной модели.

```{r}

#получим матрицу предикторов
tmp_imp <- mice(
    data, m = 1, maxit = 0, printFlag = FALSE, seed = 29094
)

#зададим пассивную импутацию для ИМТ
my_methods <- tmp_imp$method
my_methods["bmi"] <- "~ I(weight / (height / 100)^2)"

# исключим восполение переменных за счет ИМТ 
my_pred_mat <- tmp_imp$predictorMatrix
my_pred_mat[c("height", "weight"), "bmi"] <- 0L


# импутация данных с использованием выставленных выше параметров
imp <- mice(
    data, m = 10, maxit = 10, printFlag = FALSE, seed = 29094,
    predictorMatrix = my_pred_mat,
    method = my_methods
)

# диагностика импутации
plot(imp)
stripplot(imp)
```

Исзодя из графиков диагностики импутации видно: данные при импутации не образуют трендов, распределние импутированных значений соответсвует распределниею исходных значений.

```{r}
fits <- with(imp, lm(glycohemoglobin ~ bmi*insulin + male + age))

pool(fits) %>% 
    broom::tidy() %>% 
  as.data.frame() %>% 
  mutate(
    across(where(is.numeric), ~ round(., digits = 3))
  ) %>% 
  flextable()

# 0.009356845 + 1.96 * 0.01306427
# 0.009356845 - 1.96 * 0.01306427
# 
# 2.055550479 + 1.96 * 0.55713324	
# 2.055550479 - 1.96 * 0.55713324
# 
# -0.017748081 + 1.96 * 0.01697809	
# -0.017748081 - 1.96 * 0.01697809
```

В результате импутации данных мы получили следующие оценки зависимости уровня гликированного гемоглобина от ИМТ с учетом применения препаратов инсулина и поправкой на пол и возраст:

1) увеличение ИМТ на 1 кг/м^2 статистически не значимо увеличивает уровень гликированного гемоглобина на 0,009% п.п. (95% ДИ [-0.016; 0.034], р-значение = 0.47).

2) Прием препаратов инсулина статистически значимо повышает уровень гликированного гемоглобина 2,05% п.п. (95% ДИ [0.96; 3.15], р-значение = 3.6 × 10⁻⁴).

3) наблюдается статистически незначимый эффект группы: эффект имт статистически не значимо различается между группами пациентов принимающих и не принимаюх инсулин на -0,018% п.п. (95% ДИ [-0.051; 0.015], р-значение = 0.298).

```{r}


fits2 <- with(imp, lm(glycohemoglobin ~ bmi*insulin))

preds <- map(
    getfit(fits2), \(x) predict(x, se.fit = TRUE)
)

preds_point <- sapply(preds, \(x) x[["fit"]])
preds_var <- sapply(preds, \(x) x[["se.fit"]]^2)

map(seq_len(nrow(preds_point)), function(i) {
    pooled <- pool.scalar(Q = preds_point[i, ], U = preds_var[i, ])
    c("fit" = pooled[["qbar"]], 
      "se.fit" = sqrt(pooled[["t"]]))
}) %>% 
    reduce(bind_rows) %>% 
    bind_cols(data) %>% 
  drop_na(insulin, bmi) %>% 
  arrange(insulin, bmi) %>%
    ggplot(aes(bmi, fit,  fill = insulin)) +
    geom_ribbon (aes(ymin = fit - 1.96* se.fit, 
                     ymax = fit + 1.96* se.fit))+
    geom_line()
```



