---
title: "ДЗ. Специфика медицинских данных"
author: "Oksana Plastinina"
date: "`r Sys.Date()`"
output: 
 html_document:
    self_contained: true
    code_folding: hide
    code_download: false
    number_sections: false
    toc: true
    toc_float: true
    toc_title: Оглавление
    fig_align: center
    dev: png
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**ИСПРАВЛЕНИЯ:**

- Скрыт вывод предупреждений и сообщений в отчете

- Наблюдения гемоглобина равные 0 заменены на NA (до этого использовали подход удаления всех параметров наблюдения пациента)

- Перепроверены значения статистик высокого ИМТ у пациентов

Главы, содержащие изменения помечены "+ ИСПРАВЛЕНИЯ"


```{r message = FALSE, warning = FALSE}

library(readxl)
library(tidyverse)
library(stringr)
library(flextable)
library(pROC)
library(ggplot2)
```

```{r}
trauma_row <- read_excel('trauma.xlsx')
```

```{r echo = FALSE}
thememine <- theme(
  plot.title = element_text(size = 15, hjust = 0.5),
  axis.title = element_text(size = 12),
  axis.text = element_text(size = 9, colour = 'grey10'),
  panel.background = element_rect(fill = 'white'),
  panel.grid = element_line(colour = 'grey90')
)

theme_set(thememine)
```


## Очистка базы данных

### Анализ значений переменных исходной базы данны
```{r}
#проводим первичный анализ
cat('Статистика по всем переменных исходной базы данных\n')
summary(trauma_row)
cat('\nТипы всех переменных исходной базы данных\n')
str(trauma_row)
cat('\nАнализ разности САД и ДАД\n')
trauma_row %>% 
  mutate(
    dif = SBP - DBP
  ) %>%
  select(dif) %>% 
  summary()
```
```{r}
trauma_row %>% 
  ggplot() +
  geom_histogram(aes(x = Hb), fill = 'seagreen', colour = 'black')+
  labs(
    title = 'Распределение значений уровня гемоглобина при поступлении',
    x = 'Уровень гемоглобина',
    y = 'Число пациентов'
  )+
  scale_x_continuous(breaks = seq(0,18, 1))+
  scale_y_continuous(breaks = seq(0,170, 15))
```

Значение уровня гемоглобина при поступлении иммет минимальный показатель 0, что не явяляется возможным. Для того, чтобы определить, как распределены значения данного признака в исходных данных построим гистограмму. Из графика видно, что примерно 20 значений соответсвуют 0. Остальные значения больше 9 и меньше 17, что соответсвует возможным значениям. 

В типах данных есть ошибки внесения переменной Height из-за чего она определяестя как текстовая переменная. Также Death лучше скорее рассматривать как фактор.

Значения остальных переменных рассматриваем как возможные.

### Подготовка базы данных для работы + ИСПРАВЛЕНИЯ
```{r}
#Чистка данных

trauma <- trauma_row %>% 
  mutate(
    Hb = case_when(Hb == '0' ~ NA,
                   TRUE ~ Hb),
    Death = as.factor(Death),
    Height = as.numeric(str_remove_all(Height, '"')),
    Heightm = round((Height*2.54)/100,2),
    Weightkg = round(Weight/2.2,1)
  )

cat('Статистика по всем переменных базы данных для дальнейшей работы\n')
summary(trauma)
```

<u>Значения гемоглобина у пациентов заменили на пропуски.</u> Сделали Death фактором. Исправили ошибки внесения переменной Height и сделелали ее числовой. Создали переменные Heightm и Weightkg, соответствующие росту в м и массе в кг. 

## Задание 1-2. Анализ данных. Описательная статистика

### Анализ качественных переменных

```{r}
#статистика для пола по группам исхода

sexcount <- trauma %>% 
  group_by(Death, Sex) %>% 
  summarise(
    'Количество пациентов и их % от общего числа' = paste0 (n(), ' (', round(n()/nrow(trauma),3) * 100, '%)' ),
  .groups = 'drop'
  ) %>% 
  bind_rows(
    trauma %>% 
  group_by(Death) %>% 
  summarise(
    'Sex' = 'Всего с таким исходом',
    'Количество пациентов и их % от общего числа' = paste0 (n(), ' (', round(n()/nrow(trauma),3) * 100, '%)' ),
  .groups = 'drop'
  )) %>% 
  arrange(Death, Sex) %>% 
  mutate(
    Sex = case_when(
      Sex == 'Male' ~ 'Мужчина',
      Sex == 'Female' ~ 'Женщина',
      TRUE ~ Sex
    ),
    Death = recode(Death, '0' = 'не наступил летальный исход в течение 24 часов', '1' = 'наступил летальный исход в течение 24 часов')
  ) %>% 
  rename('Исход' = Death, 'Пол' = Sex) %>% 
  as_grouped_data(groups = 'Исход')

coomment2 <- paste0(
  'Всего пациентов в исследовании ',
  nrow(trauma),
  '. \nИз них ',
  sum(trauma$Sex == 'Female'),
  ' (',
  round(sum(trauma$Sex == 'Female')/nrow(trauma),3) * 100,
  '%) пациентов - женщины, ', 
  sum(trauma$Sex == 'Male'),
  ' (',
  round(sum(trauma$Sex == 'Male')/nrow(trauma),3) * 100,
  '%) - мужчины.'
)

#визуализация
sexcount %>% 
  as_flextable() %>%
  theme_box() %>% 
  bg(part = "header", bg = "aquamarine") %>% 
  bg(i = ~ !is.na(Исход), bg = "grey90", part = "body") %>% 
  align(part = 'all', align = 'center') %>% 
  set_table_properties(layout = 'autofit', width = 0.8) %>% 
  add_footer_lines(coomment2) %>% 
  set_caption('Таблица 1 - Описательные статистики качественных признаков')
```

Из таблицы видно, что большую часть пациентов (62.7%) составляют мужчины. У 60% всех пациентов исследования не наступил летальный исход в течени 24 часов.

### Анализ количественных переменных

Сразу введем в базу данных переменную ИМТ для оценки параметров массы и роста

```{r}
trauma <- trauma %>% 
  mutate(
    BMI = round(Weightkg/(Heightm^2), 1)
  )
```

```{r}
#сосздаем лист со статистикой для количественных признаков
statistic <- list(
  'Количество NA' = ~sum(is.na(.x)) %>% as.character(),
  'Количество \nнаблюдений' = ~sum(!is.na(.x)) %>% as.character(),
  'Среднее' = ~round(mean(.x, na.rm = T), 1) %>% as.character(),
  'Медиана' = ~median(.x, na.rm = T) %>% as.character(),
  'Стандатрное \nотклонение' = ~sd(.x, na.rm = T) %>% round(2) %>% as.character(),
  '25-75 квартили' = ~paste0(quantile(.x, .25, na.rm = TRUE), ' - ', quantile(.x, .75, na.rm = TRUE)),
  'Мин-макс \nзначение' = ~paste0(min(.x, na.rm = T), ' - ', max(.x, na.rm = T)) %>% as.character()
  )
```

```{r}
#создаем дата фрейм со статистикой
statistic_traumaDeath <- trauma %>%
  group_by(Death) %>% 
  summarise( 
    across(where(is.numeric) & !c('id', 'Height', 'Weight'), statistic)
    ) %>% 
  pivot_longer(!Death, names_to = c('Variable', 'Statustic'), names_sep = '_', values_to = 'Value') %>% 
  pivot_wider(names_from = 'Variable', values_from = 'Value') %>% 
  mutate(
  Death = recode(Death, '0' = 'не наступил летальный исход в течение 24 часов', '1' = 'наступил летальный исход в течение 24 часов'))%>%
  rename('Исход' = Death ) %>% 
  as_grouped_data(groups = 'Исход')

comments <- 'САД - систолическое артериальное давление при поступлении; \nДАД - диастолическое артериальное давление при поступлении; \nFOUR – балл по шкале комы FOUR при поступлении; \nGSC – балл по шкале комы Глазго при поступлении; \nHb – уровень гемоглобина при поступлении.'


#Визуализируем статистику с помощью flextable
as_flextable(statistic_traumaDeath) %>% 
  theme_box() %>% 
  bg(part = "header", bg = "aquamarine") %>% 
  bg(i = ~ !is.na(Исход), bg = "grey90", part = "body") %>%
  align(part = 'all', align = 'center') %>% 
  set_header_labels(Statustic = 'Параметр', Age = 'Возраст, \nгод', SBP = 'САД, \nмм рт.ст.', DBP = 'ДАД, \nмм рт.ст.', Heightm = 'Рост, м', Weightkg = 'Масса, кг', Hb = 'Hb, г/дл', BMI = 'ИМТ') %>%
  set_table_properties(layout = 'autofit', width = 1) %>% 
  set_caption('Таблица 2 - Описательные статистики количественный признаков') %>% 
  add_footer_lines(comments)
```

Из таблицы можно сделать следующие выводы:
- база данных не содержит пропущенных значений за исключением 16 наблюдений уровня гемоглобина;
- количество пациентов исследования с летальным исходом в течение 24 часов меньше;
- перменная возраст и ИМТ примерно совпадают в двух группах;
- значения САД и ДАД у пациентов без летального исхода несколько выше;
- баллы по шкале комы FOUR и Глазго у пациентов без летального исхода выше, что согласуется с концепцией этих тестов;
- значения уровня гемоглобина у пациентов без летального исхода несколько выше;

#### Рассмотрим подробнее пациентов с анемией 

Для определения состояния анемии использовалии следущие референтные значения: Мужчины - 13.5–16 г/дл, Женщины - 12–14 г/дл.

```{r}
#Статистика по растпростанению анемии

#стичаем количество паиценов с анемией и их %
trauma_anemia <-  trauma %>% 
  group_by(Death,Sex) %>% 
  summarise(
    n = n(),
    patients_with_anemia = sum(ifelse((Sex == 'Female' & Hb<12) | (Sex == 'Male' & Hb<13.5), 1, 0), na.rm = T),
    .groups = 'drop') %>% 
  group_by(Sex) %>% 
  mutate(
    '% числа пациентов с анемией  в этой группе среди этого пола' = paste0(round(patients_with_anemia/sum(n)*100), '%')) %>%
  ungroup() %>% 
  mutate('% числа пациентов с анемией cреди всех пациентов' = paste0(round(patients_with_anemia/nrow(trauma)*100,1), '%'),
         '% числа пациентов с анемией cреди всех пациентов с анемией' = paste0(round(patients_with_anemia/sum(patients_with_anemia)*100,1), '%')
  ) %>% 
  mutate(
  Sex = case_when(
    Sex == 'Male' ~ 'Мужчина',
    Sex == 'Female' ~ 'Женщина',
    TRUE ~ Sex
  )) %>% 
  ungroup() %>%
  mutate(Death = recode(Death, '0' = 'не наступил летальный исход в течение 24 часов', '1' = 'наступил летальный исход в течение 24 часов'))%>%
  rename('Исход' = Death ) %>%
  as_grouped_data(groups = 'Исход')

#Формулируем комментарий к таблице
general_anemia <- paste0(
  'Количество пациентов с анемией - ', 
  sum(trauma_anemia$patients_with_anemia, na.rm = TRUE), 
  ', что составляет ', 
  round(sum(trauma_anemia$patients_with_anemia,na.rm = TRUE)/nrow(trauma)*100,1),
  '% от общего числа пациентов. \nРеферентные значения: Мужчины - 13.5–16 г/дл, Женщины - 12–14 г/дл.' 
  ) 

#визуализируем 
trauma_anemia %>% 
  as_flextable() %>% 
  theme_box() %>% 
  bg(part = "header", bg = "aquamarine") %>%
  bg(i = ~ !is.na(Исход), bg = "grey90", part = "body") %>%
  align(part = 'all', align = 'center') %>% 
  align(part = 'footer', align = 'left') %>%
  set_header_labels(Sex = 'Пол', patients_with_anemia = 'Количество пациентов \nс анемией', n = 'Количество пациентов') %>%
  set_table_properties(layout = 'autofit', width = 1)%>% 
  set_caption('Таблица 3 - Количество пациентов с анемией и их соотношения в разных группах') %>% 
  add_footer_lines(general_anemia)
  

```

45,4% пациентов страдают анемией, женщины и мужчины составляют примерно равные доли этой группы. У большей часть пациентов с анемией (63,8%) наступил летальный исход.

Анемия в нашем исследовании втречается чаще у женщин, чем у мужчин, 60% и 36% их них имеют сниженный гемоглобин соответственно. Большая половина женщин и мужчин с анемией имели летальный исход в результате ЧМТ в течение 24 ч, 58% и 69% соответственно.

#### Рассмотрим подробнее пациентов с высоким ИМТ (>30) + ИСПРАВЛЕНИЯ

```{r}
#считаем пациентов с высоким ИМТ и их соотношения относительно разных групп
trauma_BMI <- trauma %>% 
  # filter(BMI > 30) %>% 
  group_by(Death) %>% 
  summarise(
    ngener = n() %>% as.character(),
    nhighbmi = paste0(sum(BMI > 30), ' (', round(sum(BMI>30)/sum(trauma$BMI>30)*100,1), '%)'),
      # sum(BMI > 30) %>% as.character(),
    perhighbmi = paste(round(sum(BMI>30)/n()*100,1), '%')
  ) %>% 
  mutate(
  Death = recode(Death, '0' = 'Не наступил', '1' = 'Наступил'))

#визуализируем
trauma_BMI %>% 
  flextable() %>% 
  theme_box() %>% 
  bg(part = "header", bg = "aquamarine") %>% 
  align(part = 'all', align = 'center') %>% 
 set_header_labels(ngener = 'Количество пациентов', nhighbmi = 'Количество пациентов с высоким ИМТ (% от всех пациентов с высоким ИМТ)', perhighbmi = '% пациентов с высоким ИМТ в этой группе', Death = 'Летальный исход в течение 24 ч') %>% 
  set_table_properties(layout = 'autofit', width = 1) %>% 
  set_caption('Таблица 4 - Количество пациентов с высоким ИМТ (>30)  и их соотношение в группах с разным исходом')

```


КОД С РАСЧЕТАМИ СРЕДНЕГО, СО И ЧИСЛА ПАЦИЕНТОВ РАСПОЛАГАЕТСЯ ВНУТРИ ФУНКЦИИ cat

Несовпадение количества пациентов с ИМТ > 30 был связан с округлением значения ИМТ (код в начале главы "Анализ количественных переменных"). При округлении до целого числа рассчитанного ИМТ (с помощью функции round()) в расчет не берутся наблюдения 30,1-30,5.

```{r}
# trauma_row %>% 
#   mutate(
#     Height = as.numeric(str_remove_all(Height, '"')),
#     Heightm = round((Height*2.54)/100,2),
#     Weightkg = round(Weight/2.2,1),
#     BMI = round(Weightkg/(Heightm^2), 1)
#   ) %>% 
#   filter(BMI>30) %>% 
#   nrow()

# как вывод - 71 строка
```

```{r}
# trauma_row %>% 
#   mutate(
#     Height = as.numeric(str_remove_all(Height, '"')),
#     Heightm = round((Height*2.54)/100,2),
#     Weightkg = round(Weight/2.2,1),
#     BMI = round(Weightkg/(Heightm^2), 0)
#   ) %>% 
#   select(id, BMI) %>%
#   filter(BMI>30) %>% 
#   nrow()

# как вывод - 51 строка
```

```{r}
cat(paste0(
  'Cредний уровень ИМТ пациентов, включенных в исследование - ',
  round(mean(trauma$BMI)),
  ' (+/-',
  round(sd(trauma$BMI),1),
  ').',
  ' Из таблицы 1 видно, что это среднее совпадает в двух группах исхода.\nКоличество пациентов с ожирением (ИМТ>30) - ',
  sum(trauma$BMI>30),
  ', что составляет ',
  round(sum(trauma$BMI>30)/nrow(trauma)*100,1),
  '% от общего числа пациентов, включенных в исследование.',
  ' При этом в группе с летальным исходом таких пациентов меньше, ',
  trauma_BMI$nhighbmi[trauma_BMI$Death == 'Наступил'],
  ', что составляет ',
  trauma_BMI$perhighbmi[trauma_BMI$Death == 'Наступил'],
  ' этой группы. В группе без летального исхода - ',
  trauma_BMI$nhighbmi[trauma_BMI$Death == 'Не наступил'],
  ' таких пациентов, что составляет ',
  trauma_BMI$perhighbmi[trauma_BMI$Death == 'Не наступил'],
  ' этой группы. Т.к. доли пациентов среди групп исхода примерно равны, данный фактор скорее всего не влияет на исход.'
))
```

## Залание 3-4. ROC-анализ для предсказания летального исхода в течение 24 часов по переменной, характеризующей уровень гемоглобина


### Задание 3. Анализ ROC-кривой
```{r message = FALSE, warning = FALSE}
roc(as.numeric(trauma$Death), trauma$Hb, ci = TRUE) %>% 
  ggroc()+
  labs(
    title = 'ROC-кривая: гемоглобин как предиктор исхода при ЧМТ',
    x = 'Специфичность',
    y = 'Чувствительность'
  )
```

ROC-кривая выгнута в сторону верхнего левого угла, который соответствует 100% чувствительности и специфичности, что свидетельствует о возможности предсказания летального схода в течение 24 часов (после госпитализации) по причине получения черепно-мозговой травмы на основании уровня гемоглобина. Такая ROC-кривая согласуется с выводами, сделанными по таблице 3 с соотношением пациентов с анемией в разных группах исхода. Здесь также можно выделить два небольших пика, возможно соответствующих двум разных пороговым значениям уровня гемоглобина у мужчин и женщин, что скорее всего может влиять на точность теста при обобщении результатов на мужчин и женщин.

### Задание 4. Анализ площади под ROC-кривой

```{r message = FALSE, warning = FALSE}
roc(as.numeric(trauma$Death), trauma$Hb, ci = TRUE)
```

Согласно результатам ROC-анализа, гемоглобин является статистически значимым предстказателем летального исхода в течение 24 часов (после госпитализации) по причине получения черепно-мозговой травмы. Площадь под ROC-кривой - значение AUC равно 0.71, 95% ДИ не включает значение 0.5 [0.68-0.74], соответствущее случайной диагностике исхода.

Направление связи controls (случаи НЕ наступления летального исхода) > cases (случаи наступления летального исхода), связывает состояние анемии и повышенного риска летального исхода, что мы предполагали из таблицы 3.


## Задание 5. ROC-анализ предсказания летального исхода в течение 24 часов в зависимости от балла по шкале комы Глазго при поступлении


### Анализ ROC-кривой и площади под ROC-кривой

```{r fig.height=5, fig.width= 8, message = FALSE, warning = FALSE}

rocGSC <- roc(response = as.numeric(trauma$Death), predictor = trauma$GSC, ci = TRUE)

rocGSC %>% 
  ggroc()+
  labs(
    title = 'ROC-кривая: балл по шкале комы Глазго как предиктор исхода при ЧМТ',
    x = 'Специфичность',
    y = 'Чувствительность'
  )

```

```{r}
rocGSC
```

Исходя из визуализации ROC-кривой и результатов ROC-анализа, балл по шкале комы Глазго является статистически значимым предсказателем летального исхода в течение 24 часов (после госпитализации) по причине получения черепно-мозговой травмы. Площадь под ROC-кривой - значение AUC равно 0.91, 95% ДИ не включает значение 0.5 [0.896-0.929], соответствущюее случайной диагностике исхода.

Направление связи controls (случаи НЕ наступления летального исхода) > cases (случаи наступления летального исхода), связывает баллы по шкале комы Глазго и вероятности выживания. Данный результат сопоставим с концепцией шкалы комы Глазго.

### Анализ оптимального порогового значения для предсказания летального исхода в течение 24 часов по шкале комы Глазго

```{r}
#Считаем оптимальное значение
rocGSC %>% 
  coords(x = 'best', best.method = "closest.topleft") %>% 
  
#визуализирем таблицу
  flextable() %>% 
  theme_box() %>% 
  bg(part = "header", bg = "aquamarine") %>% 
  align(part = 'all', align = 'center') %>% 
 set_header_labels(threshold = 'Оптимальное порогове значение', specificity = 'Специфичность', sensitivity = 'Чувствительность') %>% 
  set_table_properties(layout = 'autofit', width = 0.8) %>% 
  set_caption('Таблица 5 - Оптимальное пороговое значение для предсказания летального исхода по шкале комы Глазго, \nопределенное методом ближайшей точки к левому краю')
```

Оптимальным для предсказания летального исхода в течение 24 часов (после госпитализации) по причине получения черепно-мозговой травмы на основании балла по шкале комы Глазго является пороговое значение равное 7.5. При таком пороговом значении (<7.5) тест будет обладает:

86% чувствительностью (т.е. в 86% случаев верно определяет случаи наступления летального исхода в течение 24 часов, в 14% случаев - получим ложноотрицательный результат) 

81% специфичностью (т.е. 81% случаев НЕ наступления летального исхода в течение 24 часов мы определим верно, в 19% случаев - получим ложноположительный результат).


## Задание . Анализ площади под ROC-кривой всех количественных данных

```{r message = FALSE, warning = FALSE}
rocallnum <- trauma %>%
  select(Death, where(is.numeric)) %>% 
  select(!c('id', 'Height', 'Weight', 'Heightm', 'Weightkg')) %>% 
  pivot_longer(cols = !Death) %>% 
  group_by(name) %>%
  summarise(AUC = roc(Death, value, ci = T)$ci[2] %>% round(3),
            AUC_LCL = roc(Death, value, ci = T)$ci[1] %>% round(3),
            AUC_UCL = roc(Death, value, ci = T)$ci[3] %>% round(3)) %>% 
  arrange(AUC) %>% 
  mutate(
    name = case_when(
      name == 'Heightm' ~ 'Рост',
      name == "Age" ~ 'Возраст', 
      name == 'SBP' ~ 'САД', 
      name == 'DBP' ~ 'ДАД', 
      name == 'Weightkg' ~ 'Масса', 
      name == 'Hb' ~ 'Уроверь гемоглобина', 
      name == 'BMI' ~ 'ИМТ',
      name == 'GSC' ~ 'Балл по шкале комы Глазго ',
      name == 'FOUR' ~ 'Балл по шкале комы FOUR ',
      TRUE ~ name
    )
  ) %>% 
  rename('Переменная' = name)

rocallnum %>% 
  flextable() %>% 
  theme_box() %>% 
  bg(part = "header", bg = "aquamarine") %>% 
  align(part = 'all', align = 'center') %>% 
  set_table_properties(layout = 'autofit', width = 0.8) %>% 
  set_caption('Таблица 6 - Значения AUC для всех количественных признаков')
```

Наименьшие площади под кривой (значения AUC), соответсвующие случайному оперделению признака 0.49 и 0.53, имеют переменные возраста и ИМТ, их 95% ДИ включают значение 0.5. Данные переменные имеют похожие статистики у двух групп исхода (то, что мы смотрели выше в таблице 2: среднее, медианы и др.) и не подходят для разделения групп и предсказания исхода.

Наилучшей предсказательной силой обладают баллы комы по шкале Глазго и FOUR, их значения AUC соответственно 0.91 и 0.93 с узкими 95% ДИ близкими к 1, что подтверждает их потенциальную состоятельность в оценке.

Остальные переменные (уровень гемоглобина, САД и ДАД) имеют промежуточные, но высокие значения AUC, 95% ДИ которых не включают 0.5, что показывает потенциально возможное использование данных параментров в оценке исхода.
