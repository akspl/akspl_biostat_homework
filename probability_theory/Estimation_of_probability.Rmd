---
title: "Estimation of probability"
author: "Oksana Plastinina"
date: "Октябрь 2025"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(flextable)
```

# Модель пациента: оценка вероятности события полного исцеления после приема терапии

```{r }

# события: 1 - произошло полное исцеление, 2 - полного исцеления не произошло
event <- c('Пациент вылечился', 'Пациенту требуется дальнейшее лечение') 

```

# Однократная оценка по выборке

```{r sample_1}

#задаем вероятности
pr1 <- 0.5 #вероятность события 1 - произошло полное исцеление
pr2 <- 1 - pr1 #вероятность события 2 - полного исцеления не произошло
Pr <- c(pr1, pr2)

# Задаем количество добровольцев 
n_patients <- 5 

# Генерируем одну выборку из наших событий из указанного числа добровольцев с учетом наших вероятностей
my_group_one_event <- sample (event, size = n_patients, replace = T, prob = Pr) 

print(my_group_one_event)

# Считаем вероятности наших событий исходя из данных эксперимента
p1 <- length(which(my_group_one_event == 'Пациент вылечился'))/(n_patients) 
p2 <- length(which(my_group_one_event == 'Пациенту требуется дальнейшее лечение'))/(n_patients)

print(c(p1, p2))

```

# Набираем статистику

```{r sample_n}

# Задаем количество добровольцев
n_patients <- 5

# Задаем количество повторений эксперимента
n_repeats <- 100

df_all_repeats <- data.frame(
  n_exp = rep(1:n_repeats, each = n_patients),
  ID =  rep(1:n_patients, n_repeats),
  cure = sample(event, size = n_patients*n_repeats, replace = T, prob = Pr)
)

```

# Оценка распределения веростностей в каждом эксперименте

```{r estimations}

theme_set(theme_bw())

#создаем датафрейм с вычисленными вероятностями каждого эксперимента
ndfg <- df_all_repeats %>% 
  group_by(n_exp) %>% 
  dplyr::summarise(p1 = (sum(cure == 'Пациент вылечился')/n_patients), p2 = (sum(cure == 'Пациенту требуется дальнейшее лечение')/n_patients) ) %>% 
  ungroup()

#генерируем графики распредления полученных вероятностей двух событий
ggplot(ndfg, aes(x = p1)) +
  geom_histogram(color = 'black', fill = 'seagreen', binwidth = 0.2) +
  labs(title = 'Распределение вероятности полного исцеления пациента',
       x = 'Вероятность полного исцеления пациента',
      y = 'Количество случаев')+
  theme(
    plot.title = element_text(hjust = 0.5)
  )

ggplot(ndfg, aes(x = p2)) +
  geom_histogram(color = 'black', fill = 'seagreen', binwidth = 0.2) +
  labs(title = 'Распределение вероятности необходимости продолжения лечения пациента',
       x = 'Вероятность необходимости продолжения лечения пациента',
      y = 'Количество случаев')+
  theme(
    plot.title = element_text(hjust = 0.5)
  )

```

# Количественные и качественные итоги

```{r conclusions}

#Оцениваем среднии вероятности двух событий, полученных в эксперименте
mean(ndfg$p1)
mean(ndfg$p2)

#Оцениваем стандартную ошибку при оценке вероятности
errorp1 <- sqrt(mean((ndfg$p1-pr1)^2))
errorp2 <- sqrt(mean((ndfg$p2-pr2)^2))

print(errorp1)

```

Ошибку можно оценивать для вероятности одного из событий, т.к. она будет совпадать со второй.

```{r echo=FALSE}
tibble(
  'Объем выборки' = c(5, 125, 500, 50000),
  'Увеличение объема выборки' = c('', 'в 25 раз', 'в 100 раз', 'в 10000 раз'),
  'Sd' = c('0,18', '0,04', '0,02', '0,002'),
  `Уменьшение Sd` = c('', 'в 4,5 раз', 'в 9 раз', 'в 90 раз')
) %>% 
  flextable() %>% 
  theme_box() %>% 
  bg(part = "header", bg = "moccasin") %>% 
  align(part = 'all', align = 'center') %>% 
  set_table_properties(layout = 'autofit', width = 0.6) %>% 
  set_caption('Зависимость ошибки оценки от объема выборки')

```

Таким образом, при анализе вероятности в зависимости от объема выборки представленным способом работает фундаментальное правило: при увеличение объема выборки в х раз, ошибка уменьшается в корень из х раз.

```{r echo=FALSE}
tibble(
  'Истинная вероятность \nсобытия' = c(0.1, 0.3, 0.5, 0.7, 0.9, 1),
  'Sd' = c(0.16, 0.19, 0.23, 0.21, 0.12, 0)
) %>% 
  flextable() %>% 
  theme_box() %>% 
  bg(part = "header", bg = "moccasin") %>% 
  align(part = 'all', align = 'center') %>% 
  set_table_properties(layout = 'autofit', width = 0.5) %>% 
  set_caption('Зависимость ошибки оценки от истинного значения заданной вероятности (объем выборки = 5)')

```


Таким образом, стандартная ошибка при оценке вероятности максимальна при значениях вероятностей = 0,5 и стремится к нулю при приближении значений вероятностей к 0 и 1.